Index: lua_apr.c
===================================================================
--- lua_apr.c	(版本 1619663)
+++ lua_apr.c	(工作副本)
@@ -19,7 +19,7 @@
 #include "lua_apr.h"
 APLOG_USE_MODULE(lua);
 
-req_table_t *ap_lua_check_apr_table(lua_State *L, int index)
+AP_LUA_DECLARE(req_table_t*) ap_lua_check_apr_table(lua_State *L, int index)
 {
     req_table_t* t;
     luaL_checkudata(L, index, "Apr.Table");
@@ -28,7 +28,7 @@
 }
 
 
-void ap_lua_push_apr_table(lua_State *L, req_table_t *t)
+AP_LUA_DECLARE(void) ap_lua_push_apr_table(lua_State *L, req_table_t *t)
 {
     lua_boxpointer(L, t);
     luaL_getmetatable(L, "Apr.Table");
@@ -79,7 +79,7 @@
 };
 
 
-int ap_lua_init(lua_State *L, apr_pool_t *p)
+AP_LUA_DECLARE(int) ap_lua_init(lua_State *L, apr_pool_t *p)
 {
     luaL_newmetatable(L, "Apr.Table");
     luaL_register(L, "apr_table", lua_table_methods);
Index: lua_apr.h
===================================================================
--- lua_apr.h	(版本 1619663)
+++ lua_apr.h	(工作副本)
@@ -29,8 +29,8 @@
 #include "apr_base64.h"
 
 
-int ap_lua_init(lua_State *L, apr_pool_t * p);
-req_table_t *ap_lua_check_apr_table(lua_State *L, int index);
-void ap_lua_push_apr_table(lua_State *L, req_table_t *t);
+AP_LUA_DECLARE(int) ap_lua_init(lua_State *L, apr_pool_t * p);
+AP_LUA_DECLARE(req_table_t*) ap_lua_check_apr_table(lua_State *L, int index);
+AP_LUA_DECLARE(void) ap_lua_push_apr_table(lua_State *L, req_table_t *t);
 
 #endif /* !_LUA_APR_H_ */
Index: lua_config.c
===================================================================
--- lua_config.c	(版本 1619663)
+++ lua_config.c	(工作副本)
@@ -257,7 +257,7 @@
     {NULL, NULL}
 };
 
-void ap_lua_load_config_lmodule(lua_State *L)
+AP_LUA_DECLARE(void) ap_lua_load_config_lmodule(lua_State *L)
 {
     luaL_newmetatable(L, "Apache2.DirConfig");  /* [metatable] */
     lua_pushvalue(L, -1);
Index: lua_config.h
===================================================================
--- lua_config.h	(版本 1619663)
+++ lua_config.h	(工作副本)
@@ -20,7 +20,7 @@
 #ifndef _APL_CONFIG_H_
 #define _APL_CONFIG_H_
 
-void ap_lua_load_config_lmodule(lua_State *L);
+AP_LUA_DECLARE(void) ap_lua_load_config_lmodule(lua_State *L);
 
 apr_status_t ap_lua_map_handler(ap_lua_dir_cfg *cfg,
                                                 const char *file,
Index: lua_request.c
===================================================================
--- lua_request.c	(版本 1619663)
+++ lua_request.c	(工作副本)
@@ -2625,7 +2625,7 @@
     return rft;
 }
 
-void ap_lua_load_request_lmodule(lua_State *L, apr_pool_t *p)
+AP_LUA_DECLARE(void) ap_lua_load_request_lmodule(lua_State *L, apr_pool_t *p)
 {
 
     apr_hash_t *dispatch = apr_hash_make(p);
@@ -2900,7 +2900,7 @@
 
 }
 
-void ap_lua_push_connection(lua_State *L, conn_rec *c)
+AP_LUA_DECLARE(void) ap_lua_push_connection(lua_State *L, conn_rec *c)
 {
     req_table_t *t;
     lua_boxpointer(L, c);
@@ -2922,7 +2922,7 @@
 }
 
 
-void ap_lua_push_server(lua_State *L, server_rec *s)
+AP_LUA_DECLARE(void) ap_lua_push_server(lua_State *L, server_rec *s)
 {
     lua_boxpointer(L, s);
     luaL_getmetatable(L, "Apache2.Server");
@@ -2935,7 +2935,7 @@
     lua_pop(L, 1);
 }
 
-void ap_lua_push_request(lua_State *L, request_rec *r)
+AP_LUA_DECLARE(void) ap_lua_push_request(lua_State *L, request_rec *r)
 {
     lua_boxpointer(L, r);
     luaL_getmetatable(L, "Apache2.Request");
Index: lua_request.h
===================================================================
--- lua_request.h	(版本 1619663)
+++ lua_request.h	(工作副本)
@@ -21,10 +21,10 @@
 #include "mod_lua.h"
 #include "util_varbuf.h"
 
-void ap_lua_load_request_lmodule(lua_State *L, apr_pool_t *p);
-void ap_lua_push_connection(lua_State *L, conn_rec *r);
-void ap_lua_push_server(lua_State *L, server_rec *r);
-void ap_lua_push_request(lua_State *L, request_rec *r);
+AP_LUA_DECLARE(void) ap_lua_load_request_lmodule(lua_State *L, apr_pool_t *p);
+AP_LUA_DECLARE(void) ap_lua_push_connection(lua_State *L, conn_rec *r);
+AP_LUA_DECLARE(void) ap_lua_push_server(lua_State *L, server_rec *r);
+AP_LUA_DECLARE(void) ap_lua_push_request(lua_State *L, request_rec *r);
 
 #define APL_REQ_FUNTYPE_STRING      1
 #define APL_REQ_FUNTYPE_INT         2
Index: lua_vmprep.c
===================================================================
--- lua_vmprep.c	(版本 1619663)
+++ lua_vmprep.c	(工作副本)
@@ -120,7 +120,7 @@
 
 #define makeintegerfield(L, n) lua_pushinteger(L, n); lua_setfield(L, -2, #n)
 
-void ap_lua_load_apache2_lmodule(lua_State *L)
+AP_LUA_DECLARE(void) ap_lua_load_apache2_lmodule(lua_State *L)
 {
     lua_getglobal(L, "package");
     lua_getfield(L, -1, "loaded");
@@ -410,7 +410,7 @@
  * Function used to create a lua_State instance bound into the web
  * server in the appropriate scope.
  */
-lua_State *ap_lua_get_lua_state(apr_pool_t *lifecycle_pool,
+AP_LUA_DECLARE(lua_State *)  ap_lua_get_lua_state(apr_pool_t *lifecycle_pool,
                                                ap_lua_vm_spec *spec, request_rec* r)
 {
     lua_State *L = NULL;
Index: lua_vmprep.h
===================================================================
--- lua_vmprep.h	(版本 1619663)
+++ lua_vmprep.h	(工作副本)
@@ -118,7 +118,7 @@
 /**
  * Fake out addition of the "apache2" module
  */
-void ap_lua_load_apache2_lmodule(lua_State *L);
+AP_LUA_DECLARE(void) ap_lua_load_apache2_lmodule(lua_State *L);
 
 /*
  * alternate means of getting lua_State (preferred eventually)
@@ -132,8 +132,9 @@
  * @cb callback for vm initialization called *before* the file is opened
  * @ctx a baton passed to cb
  */
-lua_State *ap_lua_get_lua_state(apr_pool_t *lifecycle_pool,
+AP_LUA_DECLARE(lua_State *) ap_lua_get_lua_state(apr_pool_t *lifecycle_pool,
                                                 ap_lua_vm_spec *spec, request_rec* r);
+AP_LUA_DECLARE(void) ap_lua_release_state(lua_State* L, ap_lua_vm_spec* spec, request_rec* r);
 
 #if APR_HAS_THREADS || defined(DOXYGEN)
 /*
Index: mod_lua.c
===================================================================
--- mod_lua.c	(版本 1619663)
+++ mod_lua.c	(工作副本)
@@ -115,11 +115,11 @@
     ap_lua_load_apache2_lmodule(L);
     ap_lua_load_request_lmodule(L, p);
     ap_lua_load_config_lmodule(L);
+    ap_lua_run_lua_open(L, p);
 }
 
 static int lua_open_hook(lua_State *L, apr_pool_t *p)
 {
-    lua_open_callback(L, p, NULL);
     return OK;
 }
 
@@ -145,7 +145,7 @@
     }
 }
 
-static void ap_lua_release_state(lua_State* L, ap_lua_vm_spec* spec, request_rec* r) {
+AP_LUA_DECLARE(void) ap_lua_release_state(lua_State* L, ap_lua_vm_spec* spec, request_rec* r) {
     char *hash;
     apr_reslist_t* reslist = NULL;
     if (spec->scope == AP_LUA_SCOPE_SERVER) {
@@ -2159,3 +2159,8 @@
     lua_commands,               /* table of config file commands       */
     lua_register_hooks          /* register hooks                      */
 };
+
+AP_LUA_DECLARE(int) ap_lua_handler(request_rec *r)
+{
+	return lua_handler(r);
+}
\ No newline at end of file
Index: mod_lua.h
===================================================================
--- mod_lua.h	(版本 1619663)
+++ mod_lua.h	(工作副本)
@@ -173,4 +173,6 @@
 
 int ap_lua_ssl_is_https(conn_rec *c);
 
+AP_LUA_DECLARE(int) ap_lua_handler(request_rec *r);
+
 #endif /* !_MOD_LUA_H_ */
