diff --git a/modules/lua/mod_lua.c b/modules/lua/mod_lua.c
index 459e252..a9d59eb 100644
--- a/modules/lua/mod_lua.c
+++ b/modules/lua/mod_lua.c
@@ -41,11 +41,6 @@
 #include <unistd.h>
 #endif
 
-/* getpid for Windows */
-#if APR_HAVE_PROCESS_H
-#include <process.h>
-#endif
-
 APR_IMPLEMENT_OPTIONAL_HOOK_RUN_ALL(ap_lua, AP_LUA, int, lua_open,
                                     (lua_State *L, apr_pool_t *p),
                                     (L, p), OK, DECLINED)
@@ -119,11 +114,11 @@ static void lua_open_callback(lua_State *L, apr_pool_t *p, void *ctx)
     ap_lua_load_apache2_lmodule(L);
     ap_lua_load_request_lmodule(L, p);
     ap_lua_load_config_lmodule(L);
+    ap_lua_run_lua_open(L, p);
 }
 
 static int lua_open_hook(lua_State *L, apr_pool_t *p)
 {
-    lua_open_callback(L, p, NULL);
     return OK;
 }
 
@@ -357,7 +352,9 @@ static apr_status_t lua_setup_filter_ctx(ap_filter_t* f, request_rec* r, lua_fil
         if (hook_spec == NULL) {
             continue;
         }
-        if (!strcasecmp(hook_spec->filter_name, f->frec->name)) {
+        if (!strcasecmp(hook_spec->filter_name, f->frec->name) ||
+           (!strncmp(f->frec->name, "BYTYPE:", 7) &&
+            !strcasecmp(hook_spec->filter_name, f->frec->name + 7))) {
             spec = create_vm_spec(&pool, r, cfg, server_cfg,
                                     hook_spec->file_name,
                                     NULL,
